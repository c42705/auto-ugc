<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UXÂ·AI UGC Content Agent</title>
    <!-- Bootswatch Lux Theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5/dist/lux/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .audio-player-mini {
            height: 40px;
            background: #f8f9fa;
            border-radius: 4px;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #dee2e6;
        }

        .waveform-container {
            flex-grow: 1;
            height: 30px;
        }

        .session-item {
            cursor: pointer;
            transition: all 0.2s;
        }

        .session-item:hover {
            background-color: var(--bs-gray-200);
        }

        .session-item.active {
            background-color: var(--bs-primary);
            color: white;
        }

        #archive-log-preview {
            font-size: 0.75rem;
            max-height: 150px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 10px;
            border-radius: 4px;
        }

        .script-table-container {
            max-height: calc(100vh - 350px);
            overflow-y: auto;
        }
    </style>
</head>

<body class="vh-100 overflow-hidden d-flex flex-column">

    <!-- Simple Password Overlay -->
    <div id="login-overlay"
        class="position-fixed top-0 start-0 w-100 h-100 bg-body d-flex justify-content-center align-items-center"
        style="z-index: 9999;">
        <div class="card shadow-lg border-0" style="max-width: 400px; width: 100%;">
            <div class="card-header text-bg-primary py-3 text-center">
                <img src="/static/logo-light.png" alt="UXÂ·AI Logo" class="mb-3 mt-1" style="max-height: 50px;">
                <h1 class="h5 mb-0 fw-bold">UXÂ·AI UGC access</h1>
            </div>
            <div class="card-body p-4">
                <form id="login-form">
                    <!-- Accessibility trap for password managers -->
                    <input type="text" name="username" autocomplete="username" class="visually-hidden" tabindex="-1"
                        value="admin">
                    <div class="mb-3">
                        <label class="form-label text-muted small text-uppercase fw-bold">System Password</label>
                        <input type="password" id="ui-password" class="form-control" required
                            placeholder="Enter password..." autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn btn-primary w-100 fw-bold">Unlock</button>
                    <div id="login-error" class="text-danger small mt-2 d-none fw-bold">Incorrect password.</div>
                </form>
            </div>
        </div>
    </div>

    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold ms-2 text-uppercase tracking-wide" href="#">UXÂ·AI UGC Agent</a>
            <div class="d-flex align-items-center me-2">
                <div id="pipeline-status-badge" class="badge text-bg-secondary me-3 my-auto fs-6 px-3 py-2">IDLE</div>
                <div class="d-flex align-items-center me-3" style="width: 150px;">
                    <span class="small text-light text-uppercase fw-bold me-2" style="font-size: 0.7rem;">RAM</span>
                    <div class="progress shadow-sm flex-grow-1"
                        style="height: 6px; background-color: var(--bs-gray-700);">
                        <div id="ram-progress" class="progress-bar bg-info" role="progressbar" aria-label="RAM Usage"
                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                    </div>
                </div>
                <button class="btn btn-sm btn-secondary fw-bold text-uppercase" data-bs-toggle="modal"
                    data-bs-target="#settingsModal">
                    <i class="bi bi-gear-fill me-1"></i> Settings
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow-1 d-flex overflow-hidden">

        <!-- Vertical Left Sidebar for Pipeline Progress -->
        <div class="h-100 overflow-auto bg-body-tertiary border-end p-4 shadow-sm" style="width: 320px;">
            <h2 class="h6 text-uppercase fw-bold mb-3 text-muted">Pipeline Progress</h2>
            <div id="stepper" class="d-flex flex-column gap-1">
                <!-- Steps dynamically inserted here -->
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="h-100 overflow-auto flex-grow-1 p-4">

            <div class="card shadow-sm border-0 mb-4 bg-body-tertiary">
                <div class="card-body p-4 d-flex gap-3 align-items-end">
                    <div class="flex-grow-1">
                        <label class="form-label small text-muted text-uppercase fw-bold">Topic Override
                            (Optional)</label>
                        <input type="text" id="topic-override" class="form-control border-secondary"
                            placeholder="e.g. Fintech UX gaps...">
                    </div>
                    <button id="btn-run" class="btn btn-primary fw-bold px-4 py-2 text-uppercase"
                        style="min-width: 180px;"><i class="bi bi-play-fill me-1"></i> RUN PIPELINE</button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="card shadow-sm border-0 mb-5">
                <div class="card-header bg-transparent border-bottom-0 pt-3 pb-0">
                    <ul class="nav nav-tabs border-bottom-0" id="mainTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active fw-bold text-uppercase" id="log-tab" data-bs-toggle="tab"
                                data-bs-target="#log-pane" type="button" role="tab">Live Log</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold text-uppercase" id="script-tab" data-bs-toggle="tab"
                                data-bs-target="#script-pane" type="button" role="tab">Script Viewer</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold text-uppercase" id="output-tab" data-bs-toggle="tab"
                                data-bs-target="#output-pane" type="button" role="tab">Output</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold text-uppercase" id="archive-tab" data-bs-toggle="tab"
                                data-bs-target="#archive-pane" type="button" role="tab"><i
                                    class="bi bi-archive-fill me-1"></i> Archive</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body bg-body-tertiary rounded-bottom">
                    <div class="tab-content" id="mainTabContent">
                        <div class="tab-pane fade show active" id="log-pane" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button id="clear-log"
                                    class="btn btn-sm btn-secondary text-uppercase flex-shrink-0">Clear
                                    Log</button>
                            </div>
                            <div id="log-view" class="font-monospace overflow-auto p-3 bg-body rounded border"
                                style="min-height: 400px; max-height: 600px;"></div>
                        </div>
                        <div class="tab-pane fade" id="script-pane" role="tabpanel">
                            <div id="qa-summary" class="mb-3"></div>
                            <div id="script-cards" class="row g-3">
                                <h3 class="h5 text-center text-muted py-5 mt-4">No script generated yet.</h3>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="output-pane" role="tabpanel">
                            <div id="output-view" class="row">
                                <h3 class="h5 text-center text-muted py-5 mt-4">Waiting for final render...</h3>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="archive-pane" role="tabpanel">
                            <div class="row h-100" style="min-height: 500px;">
                                <div class="col-md-3 border-end">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4 class="h6 mb-0 text-uppercase fw-bold">Recent Sessions</h4>
                                        <button id="refresh-sessions"
                                            class="btn btn-sm btn-secondary text-uppercase px-2"
                                            style="font-size: 0.7rem;">
                                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                                        </button>
                                    </div>
                                    <div id="session-list" class="list-group list-group-flush rounded border">
                                        <!-- Sessions dynamic list -->
                                    </div>
                                </div>
                                <div class="col-md-9 ps-4">
                                    <div id="session-detail-view" class="d-none">
                                        <div class="d-flex justify-content-between align-items-start mb-4">
                                            <div>
                                                <h3 id="detail-session-id" class="h5 fw-bold mb-1">--</h3>
                                                <p id="detail-session-meta" class="small text-muted mb-0">--</p>
                                            </div>
                                            <div id="session-actions">
                                                <!-- Action buttons -->
                                            </div>
                                        </div>

                                        <ul class="nav nav-pills nav-sm mb-3" id="detailTabs" role="tablist">
                                            <li class="nav-item"><button class="nav-link active py-1 px-3"
                                                    data-bs-toggle="tab" data-bs-target="#detail-script">Script &
                                                    Audio</button></li>
                                            <li class="nav-item"><button class="nav-link py-1 px-3" data-bs-toggle="tab"
                                                    data-bs-target="#detail-clips">Videos</button></li>
                                            <li class="nav-item"><button class="nav-link py-1 px-3" data-bs-toggle="tab"
                                                    data-bs-target="#detail-log">Logs</button></li>
                                            <li class="nav-item"><button class="nav-link py-1 px-3" data-bs-toggle="tab"
                                                    data-bs-target="#detail-meta">Social Metadata</button></li>
                                        </ul>

                                        <div class="tab-content border rounded bg-white p-3">
                                            <div class="tab-pane fade show active" id="detail-script">
                                                <div class="script-table-container">
                                                    <table class="table table-sm table-hover align-middle mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>ID</th>
                                                                <th>Script Text</th>
                                                                <th style="width: 100px;">Visual</th>
                                                                <th style="width: 250px;">Audio Player</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="detail-script-body">
                                                            <!-- Script rows dynamically inserted -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="tab-pane fade" id="detail-clips">
                                                <div id="detail-clips-grid" class="row g-3">
                                                    <!-- Clip players here -->
                                                </div>
                                            </div>
                                            <div class="tab-pane fade" id="detail-log">
                                                <pre id="archive-log-preview" class="font-monospace mb-0"></pre>
                                            </div>
                                            <div class="tab-pane fade" id="detail-meta">
                                                <div id="detail-meta-content" class="small">
                                                    <!-- Metadata dynamic content -->
                                                    <div class="text-center py-4 text-muted">No metadata available.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="session-empty-state" class="text-center py-5">
                                        <div class="display-1 text-muted opacity-25 mb-3"><i
                                                class="bi bi-folder-fill"></i></div>
                                        <h5 class="text-muted">Select a session from the list to view details</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Review Modal -->
    <div class="modal fade" id="reviewModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="reviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-warning shadow-lg border-2">
                <div class="modal-header text-bg-warning py-3">
                    <h2 class="h5 modal-title mb-0 text-dark fw-bold" id="reviewModalLabel"><i
                            class="bi bi-hourglass-split me-1"></i> Review Window: <span id="review-step-name">--</span>
                    </h2>
                    <span id="countdown-text" class="text-dark small text-uppercase ms-3 mt-1 fw-bold">Auto-continuing
                        in --s</span>
                </div>
                <div class="progress rounded-0" style="height: 8px;">
                    <div id="countdown-bar" class="progress-bar bg-danger" role="progressbar"
                        aria-label="Review Countdown" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"
                        style="width: 100%"></div>
                </div>
                <div class="modal-body bg-body-tertiary">
                    <textarea id="review-json" class="font-monospace bg-body text-body border rounded p-2 mb-3 w-100"
                        style="font-size: 0.85rem; height: 300px;"></textarea>
                    <div class="d-flex justify-content-end gap-2">
                        <button id="btn-submit-override" class="btn btn-primary fw-bold"><i
                                class="bi bi-check-lg me-1"></i> Submit My Changes</button>
                        <button id="btn-continue" class="btn btn-secondary fw-bold"><i
                                class="bi bi-skip-forward-fill me-1"></i> Continue Now</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header text-bg-primary">
                    <h2 class="h5 modal-title fw-bold text-white">System Settings</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Review Timeout (Seconds)</label>
                        <input type="number" id="setting-timeout" class="form-control" value="120">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">QA Approval Threshold (<span id="qa-threshold-val">7.5</span>)</label>
                        <input type="range" class="form-range" min="5" max="9" step="0.5" id="setting-threshold"
                            value="7.5">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ntfy URL</label>
                        <input type="text" id="setting-ntfy" class="form-control"
                            placeholder="https://ntfy.stargety.com/ugc">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Main LLM Model</label>
                        <input type="text" id="setting-model" class="form-control"
                            placeholder="anthropic/claude-sonnet-4-6">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button id="btn-save-settings" type="button" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <script>
        const socket = io();
        let sessionToken = sessionStorage.getItem('ui_token');
        let isRunning = false;
        let authReady = false;  // true once we know the token is valid
        let wavesurfers = []; // track wavesurfer instances to clean up

        function cleanupWavesurfers() {
            wavesurfers.forEach(ws => {
                if (ws && typeof ws.destroy === 'function') ws.destroy();
            });
            wavesurfers = [];
        }

        function authUrl(url) {
            if (!url) return url;
            if (!sessionToken) return url;
            const sep = url.includes('?') ? '&' : '?';
            return `${url}${sep}pwd=${encodeURIComponent(sessionToken)}`;
        }

        function createMiniAudioPlayer(url, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = `
                <div class="audio-player-mini">
                    <button class="btn btn-sm btn-primary rounded-circle p-0 d-flex align-items-center justify-content-center play-btn" style="width: 24px; height: 24px;">
                        <i class="bi bi-play-fill" style="font-size: 0.75rem;"></i>
                    </button>
                    <div class="waveform-container"></div>
                    <span class="small text-muted duration" style="font-size: 0.65rem;">0:00</span>
                </div>
            `;

            const ws = WaveSurfer.create({
                container: container.querySelector('.waveform-container'),
                waveColor: '#ced4da',
                progressColor: '#343a40',
                cursorWidth: 0,
                barWidth: 2,
                barGap: 1,
                barRadius: 2,
                height: 30,
                url: url,
                fetchParams: {
                    headers: sessionToken ? { 'X-UI-Password': sessionToken } : {}
                }
            });

            const playBtn = container.querySelector('.play-btn');
            playBtn.onclick = () => ws.playPause();

            ws.on('play', () => playBtn.innerHTML = '<i class="bi bi-pause-fill" style="font-size: 0.75rem;"></i>');
            ws.on('pause', () => playBtn.innerHTML = '<i class="bi bi-play-fill" style="font-size: 0.75rem;"></i>');
            ws.on('ready', () => {
                const dur = ws.getDuration();
                container.querySelector('.duration').innerText = `${Math.floor(dur / 60)}:${Math.floor(dur % 60).toString().padStart(2, '0')}`;
            });

            wavesurfers.push(ws);
            return ws;
        }

        // Initialize Bootstrap modal components immediately â€” the DOM is ready
        // since this script is at the bottom of <body>. DOMContentLoaded may
        // not fire until AFTER async socket events, so we avoid that race.
        const reviewModalInstance = new bootstrap.Modal(document.getElementById('reviewModal'));
        const settingsModalInstance = new bootstrap.Modal(document.getElementById('settingsModal'));

        // API Request wrapper to inject header
        async function apiCall(url, options = {}) {
            if (!options.headers) options.headers = {};
            if (sessionToken) options.headers['X-UI-Password'] = sessionToken;
            return fetch(url, options);
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("[LOGIN] Form submitted");
            const pass = document.getElementById('ui-password').value;
            console.log("[LOGIN] Extracted password from input. Length:", pass.length);
            const btn = e.target.querySelector('button[type="submit"]');
            const errorDiv = document.getElementById('login-error');
            const ogText = btn.innerHTML;

            errorDiv.classList.add('d-none');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span><span role="status">Unlocking...</span>';

            try {
                console.log("[LOGIN] Sending POST request to /api/login");
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pass })
                });

                console.log("[LOGIN] Response received. Status:", res.status, "OK:", res.ok);

                if (res.ok) {
                    console.log("[LOGIN] Authentication successful. Setting token and hiding overlay.");
                    sessionToken = pass;
                    sessionStorage.setItem('ui_token', pass);
                    document.getElementById('login-overlay').classList.remove('d-flex');
                    document.getElementById('login-overlay').classList.add('d-none');
                    authReady = true;
                    syncServerState(); // restore pipeline state right after login
                } else {
                    console.error("[LOGIN] Login failed: Password incorrect or server denied access. HTTP Status:", res.status);
                    errorDiv.innerText = "Incorrect password.";
                    errorDiv.classList.remove('d-none');
                }
            } catch (err) {
                console.error("[LOGIN] Login request failed due to a network or application error:", err);
                errorDiv.innerText = "Connection error. Check console.";
                errorDiv.classList.remove('d-none');
            } finally {
                console.log("[LOGIN] Restoring button state.");
                btn.disabled = false;
                btn.innerHTML = ogText;
            }
        });

        // Initialize display by asking if server requires auth
        async function checkAuthOnLoad() {
            console.log("[AUTH_INIT] starting checkAuthOnLoad. Current local token exists?:", !!sessionToken);
            try {
                // 1. Is auth required?
                console.log("[AUTH_INIT] Fetching /api/auth_config");
                const cfgRes = await fetch('/api/auth_config');
                const cfg = await cfgRes.json();
                console.log("[AUTH_INIT] Auth config received:", cfg);

                if (!cfg.auth_required) {
                    console.log("[AUTH_INIT] Auth not required. Hiding overlay.");
                    sessionToken = null;
                    document.getElementById('login-overlay').classList.remove('d-flex');
                    document.getElementById('login-overlay').classList.add('d-none');
                    authReady = true;
                    syncServerState(); // restore state when auth not required
                    return;
                }

                // 2. Auth required, do we have a cached token?
                console.log("[AUTH_INIT] Auth required. Do we have a token stored?:", !!sessionToken);
                if (sessionToken) {
                    console.log("[AUTH_INIT] Testing cached token via /api/login POST");
                    const res = await apiCall('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: sessionToken })
                    });

                    console.log("[AUTH_INIT] Cached token test response. Status:", res.status, "OK:", res.ok);
                    if (res.ok) {
                        console.log("[AUTH_INIT] Cached token is valid. Hiding overlay.");
                        document.getElementById('login-overlay').classList.remove('d-flex');
                        document.getElementById('login-overlay').classList.add('d-none');
                        authReady = true;
                        syncServerState(); // restore state with cached token
                    } else {
                        console.warn("[AUTH_INIT] Cached token invalid or server rejected. Clearing token.");
                        sessionToken = null;
                        sessionStorage.removeItem('ui_token');
                    }
                }
            } catch (err) {
                console.error("[AUTH_INIT] Initial auth check failed", err);
            }
        }
        checkAuthOnLoad();

        const steps = [
            "research", "review_research", "ideation", "scripting",
            "review_script", "qa_loop", "review_qa", "voiceover",
            "avatar_clips", "images", "assembly", "qa_video",
            "metadata", "finalize"
        ];

        const stepLabels = {
            "research": "Market Research",
            "review_research": "Review Findings",
            "ideation": "Content Ideas",
            "scripting": "Script Writing",
            "review_script": "Human Script Edit",
            "qa_loop": "QA Self-Correction",
            "review_qa": "Final Approval",
            "voiceover": "AI Voice Gen",
            "avatar_clips": "HeyGen Avatar",
            "images": "DALL-E Visuals",
            "assembly": "Video Rendering",
            "qa_video": "Technical Check",
            "metadata": "Social Metadata",
            "finalize": "Packaging"
        };

        // Per-step live timing state
        const stepTimers = {};   // step -> setInterval id for live ticking
        const stepStartTs = {};  // step -> server epoch (seconds)

        let reviewTimer = null;
        let reviewStep = null;

        // Initialize Stepper
        const stepperEl = document.getElementById('stepper');
        steps.forEach((step, idx) => {
            const el = document.createElement('div');
            el.id = `step-${step}`;
            el.className = 'd-flex align-items-center mb-3 p-2 rounded';
            el.innerHTML = `
                <div class="d-flex align-items-center justify-content-center rounded-circle border border-2 border-secondary text-secondary fw-bold me-3 flex-shrink-0 stepper-number" style="width: 30px; height: 30px;">
                    ${idx + 1}
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold" style="font-size: 0.8rem;">${stepLabels[step]}</div>
                    <small class="step-status text-muted" style="font-size: 0.7rem;">Pending</small>
                </div>
                <div class="step-elapsed text-muted ms-2" style="font-size: 0.7rem; min-width: 42px; text-align: right;"></div>
            `;
            stepperEl.appendChild(el);
        });

        // reviewModalInstance already initialized eagerly above.

        // â”€â”€â”€ Helper: format elapsed seconds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function fmtElapsed(secs) {
            if (secs === null || secs === undefined) return '';
            const s = Math.round(secs);
            if (s < 60) return `${s}s`;
            const m = Math.floor(s / 60);
            const rem = s % 60;
            return `${m}m ${rem}s`;
        }

        // â”€â”€â”€ Start / stop live elapsed timer for a step â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function startLiveTimer(step, startTs) {
            stopLiveTimer(step);
            stepStartTs[step] = startTs;
            const elapsedEl = document.querySelector(`#step-${step} .step-elapsed`);
            if (!elapsedEl) return;

            function tick() {
                const elapsed = (Date.now() / 1000) - stepStartTs[step];
                elapsedEl.textContent = fmtElapsed(elapsed);
            }
            tick();
            stepTimers[step] = setInterval(tick, 1000);
        }

        function stopLiveTimer(step) {
            if (stepTimers[step]) {
                clearInterval(stepTimers[step]);
                delete stepTimers[step];
            }
            delete stepStartTs[step];
        }

        // â”€â”€â”€ Socket Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        socket.on('step_start', (data) => {
            updateStep(data.step, 'running');
            if (data.start_ts) startLiveTimer(data.step, data.start_ts);
        });

        socket.on('step_complete', (data) => {
            stopLiveTimer(data.step);
            updateStep(data.step, 'done', data);
            // Show final duration
            const elapsedEl = document.querySelector(`#step-${data.step} .step-elapsed`);
            if (elapsedEl && data.duration_s != null) {
                elapsedEl.textContent = fmtElapsed(data.duration_s);
            }
        });

        socket.on('step_error', (data) => {
            stopLiveTimer(data.step);
            updateStep(data.step, 'error', data);
            setIdleState();
        });

        socket.on('pipeline_log', (data) => appendLog(data));
        socket.on('ram_update', (data) => updateRamBar(data));
        socket.on('review_window_open', (data) => {
            updateStep(data.step, 'review');
            if (data.start_ts) startLiveTimer(data.step, data.start_ts);
            showReviewPanel(data);
        });
        socket.on('review_window_timeout', () => hideReviewPanel());
        socket.on('override_received', () => {
            hideReviewPanel();
            appendLog({ level: 'SUCCESS', msg: 'Human override applied successfully.' });
        });

        socket.on('pipeline_complete', (data) => {
            showOutputPanel(data);
            setIdleState();
        });

        // â”€â”€â”€ Socket reconnect â†’ re-sync state from server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // We use 'connect' for ALL connections (initial + reconnects).
        // Guard with authReady so we don't call syncServerState before auth.
        socket.on('connect', () => {
            if (authReady) {
                appendLog({ level: 'INFO', msg: 'ðŸ”„ Reconnected â€” restoring pipeline state...' });
                syncServerState();
            }
        });

        socket.on('disconnect', () => {
            const logView = document.getElementById('log-view');
            if (logView) {
                const line = document.createElement('div');
                line.className = 'mb-1 text-warning fw-bold';
                line.style.fontSize = '0.9rem';
                line.innerText = `[${new Date().toLocaleTimeString()}] [WARN] Socket disconnected â€” will auto-reconnect.`;
                logView.appendChild(line);
                logView.scrollTop = logView.scrollHeight;
            }
        });

        // â”€â”€â”€ Restore full pipeline state from /api/status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        /**
         * Called on page load (after auth) and on socket reconnect.
         * Reconstructs the stepper, running timers, review panel, and badge
         * to match whatever the server reports.
         */
        async function syncServerState(silent = false) {
            let r;
            try {
                r = await apiCall('/api/status');
            } catch (netErr) {
                appendLog({ level: 'WARNING', msg: `State sync failed (network error): ${netErr.message}` });
                return;
            }

            if (!r.ok) {
                if (r.status === 401) {
                    // Auth failed â€” token may have expired
                    appendLog({ level: 'WARNING', msg: 'State sync: auth rejected (401). Please refresh and log in again.' });
                } else {
                    appendLog({ level: 'WARNING', msg: `State sync: server error ${r.status}` });
                }
                return;
            }

            let data;
            try {
                data = await r.json();
            } catch (parseErr) {
                appendLog({ level: 'WARNING', msg: `State sync: invalid JSON response.` });
                return;
            }

            // Update RAM bar
            if (data.ram_percent != null) updateRamBar({ percent: data.ram_percent });

            // Update run button + badge
            const badge = document.getElementById('pipeline-status-badge');
            if (data.status === 'running') {
                toggleRunButton(true);
            } else if (data.status === 'completed') {
                toggleRunButton(false);
                badge.className = 'badge text-bg-success me-3 my-auto fs-6 px-3 py-2';
                badge.innerText = 'COMPLETE';
            } else if (data.status === 'failed') {
                toggleRunButton(false);
                badge.className = 'badge text-bg-danger me-3 my-auto fs-6 px-3 py-2';
                badge.innerText = 'FAILED';
            } else {
                // idle â€” nothing to restore
                return;
            }

            if (!data.steps) {
                appendLog({ level: 'WARNING', msg: 'State sync: server is running but step data unavailable. Restart the server to enable step tracking.' });
                return;
            }

            // Stop all running live timers first (clean slate)
            steps.forEach(s => stopLiveTimer(s));

            let restored = 0;
            // Reconstruct each step
            steps.forEach(step => {
                const snap = data.steps[step];
                if (!snap || snap.status === 'pending') return;

                const { status, start_ts, duration_s } = snap;
                const elapsedEl = document.querySelector(`#step-${step} .step-elapsed`);

                if (status === 'running') {
                    updateStep(step, 'running');
                    if (start_ts) startLiveTimer(step, start_ts);
                    restored++;
                } else if (status === 'review') {
                    updateStep(step, 'review');
                    if (start_ts) startLiveTimer(step, start_ts);
                    restored++;
                } else if (status === 'done') {
                    updateStep(step, 'done');
                    if (elapsedEl && duration_s != null) elapsedEl.textContent = fmtElapsed(duration_s);
                    restored++;
                } else if (status === 'error') {
                    updateStep(step, 'error');
                    if (elapsedEl && duration_s != null) elapsedEl.textContent = fmtElapsed(duration_s);
                    restored++;
                }
            });

            // Restore review modal if pending â€” but ONLY if it isn't already open.
            // Calling showReviewPanel() while the user is editing would wipe their text.
            if (data.pending_review) {
                const modalEl = document.getElementById('reviewModal');
                const isAlreadyOpen = modalEl && modalEl.classList.contains('show');
                if (!isAlreadyOpen) {
                    const pr = data.pending_review;
                    showReviewPanel({
                        step: pr.step,
                        data: {},
                        timeout: Math.max(1, pr.timeout_remaining)
                    });
                }
                // If already open: leave it alone â€” the user may be editing the textarea.
            }

            if (!silent) {
                appendLog({
                    level: 'SUCCESS',
                    msg: `<i class="bi bi-check-lg me-1"></i> State restored â€” ${restored} steps recovered, pipeline ${data.status}, ${fmtElapsed(data.elapsed_seconds)} elapsed.`
                });
            }
        }

        // Core Functions
        function toggleRunButton(running) {
            isRunning = running;
            const btn = document.getElementById('btn-run');
            const badge = document.getElementById('pipeline-status-badge');
            if (running) {
                btn.className = "btn btn-secondary fw-bold px-4 py-2 text-uppercase";
                btn.innerHTML = '<i class="bi bi-stop-fill me-1"></i> CANCEL PIPELINE';
                badge.className = 'badge text-bg-primary me-3 my-auto fs-6 px-3 py-2';
                badge.innerText = 'RUNNING';
            } else {
                btn.className = "btn btn-primary fw-bold px-4 py-2 text-uppercase";
                btn.innerHTML = '<i class="bi bi-play-fill me-1"></i> RUN PIPELINE';
                // Only reset badge to IDLE if it wasn't already set to COMPLETE/FAILED
                if (!['COMPLETE', 'FAILED'].includes(badge.innerText)) {
                    badge.className = 'badge text-bg-secondary me-3 my-auto fs-6 px-3 py-2';
                    badge.innerText = 'IDLE';
                }
            }
        }

        function setIdleState() {
            toggleRunButton(false);
        }

        function updateStep(step, status, data) {
            const el = document.getElementById(`step-${step}`);
            if (!el) return;

            const numberEl = el.querySelector('.stepper-number');
            const statusEl = el.querySelector('.step-status');

            // Reset classes
            el.className = 'd-flex align-items-center mb-3 p-2 rounded';
            numberEl.className = 'd-flex align-items-center justify-content-center rounded-circle border border-2 fw-bold me-3 flex-shrink-0 stepper-number';

            if (status === 'running') {
                el.classList.add('border', 'border-primary', 'bg-body-secondary');
                numberEl.classList.add('border-primary', 'text-primary');
                statusEl.innerHTML = '<span class="spinner-grow spinner-grow-sm me-1" aria-hidden="true"></span> Running...';
            } else if (status === 'review') {
                el.classList.add('border', 'border-warning', 'bg-body-secondary');
                numberEl.classList.add('border-warning', 'text-warning');
                statusEl.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Awaiting Review';
            } else if (status === 'done') {
                numberEl.classList.add('bg-success', 'border-success', 'text-white');
                statusEl.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i> Done';
            } else if (status === 'error') {
                numberEl.classList.add('bg-danger', 'border-danger', 'text-white');
                statusEl.innerHTML = '<i class="bi bi-x-circle-fill me-1"></i> Error';
            } else {
                numberEl.classList.add('border-secondary', 'text-secondary');
                statusEl.innerHTML = 'Pending';
            }

            if (status === 'done' && (step === 'scripting' || step === 'voiceover')) {
                apiCall('/api/status').then(r => r.json()).then(state => {
                    if (state.session_id) {
                        apiCall(`/api/sessions/${state.session_id}`).then(r => r.json()).then(session => {
                            renderScript(session.script, session.audio);
                        });
                    }
                });
            }
        }

        function appendLog(data) {
            const logView = document.getElementById('log-view');
            const line = document.createElement('div');
            const levelColors = { 'INFO': 'text-body', 'SUCCESS': 'text-success fw-bold', 'WARNING': 'text-warning fw-bold', 'ERROR': 'text-danger fw-bold', 'AGENT': 'text-info fw-bold' };
            line.className = `mb-1 ${levelColors[data.level] || 'text-body'}`;
            line.style.fontSize = '0.9rem';
            const timestamp = new Date().toLocaleTimeString();
            line.innerHTML = `[${timestamp}] [${data.level}] ${data.msg}`;
            logView.appendChild(line);
            logView.scrollTop = logView.scrollHeight;
        }

        function updateRamBar(data) {
            const bar = document.getElementById('ram-progress');
            bar.style.width = data.percent + '%';
            bar.setAttribute('aria-valuenow', data.percent);

            if (data.percent > 90) bar.className = 'progress-bar bg-danger';
            else if (data.percent > 70) bar.className = 'progress-bar bg-warning';
            else bar.className = 'progress-bar bg-info';
        }

        function showReviewPanel(data) {
            reviewStep = data.step;
            document.getElementById('review-step-name').innerText = stepLabels[data.step] || data.step;
            document.getElementById('review-json').value = JSON.stringify(data.data, null, 2);
            reviewModalInstance.show();

            let remaining = data.timeout;
            const total = data.timeout;

            clearInterval(reviewTimer);
            reviewTimer = setInterval(() => {
                remaining -= 1;
                const pct = (remaining / total) * 100;
                const bar = document.getElementById('countdown-bar');
                bar.style.width = pct + '%';
                bar.setAttribute('aria-valuenow', pct);
                document.getElementById('countdown-text').innerText = `Auto-continuing in ${remaining}s`;

                if (remaining <= 20) bar.className = 'progress-bar bg-danger';
                else bar.className = 'progress-bar bg-warning';

                if (remaining <= 0) {
                    clearInterval(reviewTimer);
                    hideReviewPanel();
                }
            }, 1000);
        }

        function hideReviewPanel() {
            if (reviewModalInstance) reviewModalInstance.hide();
            clearInterval(reviewTimer);
        }

        function renderScript(script, audioFiles = []) {
            const container = document.getElementById('script-cards');
            container.innerHTML = '';

            if (!script || !script.segments) return;
            cleanupWavesurfers();

            script.segments.forEach((seg, idx) => {
                const audio = audioFiles.find(a => a.stem === `segment_${idx}` || a.name.includes(`segment_${idx}`));
                const audioHtml = audio ? `<div id="script-audio-${idx}" class="mt-2"></div>` : '';

                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';
                col.innerHTML = `
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge text-bg-secondary">${seg.id}</span>
                                <span class="badge text-bg-primary">${seg.duration_seconds}s</span>
                            </div>
                            <p class="small mb-2">${seg.text}</p>
                            ${audioHtml}
                            <hr>
                            <div class="small text-muted"><strong>Screen:</strong> ${seg.on_screen_text}</div>
                            <div class="small text-muted text-info"><strong>Mood:</strong> ${seg.emotion_cue}</div>
                        </div>
                    </div>
                `;
                container.appendChild(col);

                if (audio) {
                    setTimeout(() => createMiniAudioPlayer(audio.url, `script-audio-${idx}`), 50);
                }
            });
        }

        async function loadSessions() {
            const listContainer = document.getElementById('session-list');
            listContainer.innerHTML = '<div class="text-center p-3 small text-muted">Loading...</div>';

            try {
                const res = await apiCall('/api/sessions');
                const data = await res.json();
                listContainer.innerHTML = '';

                if (!data.sessions || data.sessions.length === 0) {
                    listContainer.innerHTML = '<div class="text-center p-3 small text-muted">No sessions found</div>';
                    return;
                }

                data.sessions.forEach(s => {
                    const btn = document.createElement('button');
                    btn.className = 'list-group-item list-group-item-action session-item p-3 border-0 border-bottom';
                    btn.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-bold small">${s.id}</span>
                            <span class="badge ${s.has_clips ? 'text-bg-success' : 'text-bg-light'} px-1" style="font-size: 0.6rem;">${s.has_clips ? 'READY' : 'PARTIAL'}</span>
                        </div>
                        <div class="small text-muted" style="font-size: 0.65rem;">
                            ${s.has_script ? '<i class="bi bi-check me-1"></i>Script ' : ''} ${s.has_audio ? '<i class="bi bi-check me-1"></i>Audio ' : ''} ${s.has_clips ? '<i class="bi bi-check me-1"></i>Video' : ''}
                        </div>
                    `;
                    btn.onclick = () => loadSessionDetail(s.id, btn);
                    listContainer.appendChild(btn);
                });
            } catch (err) {
                listContainer.innerHTML = '<div class="text-center p-3 small text-danger">Error loading archive</div>';
            }
        }

        async function loadSessionDetail(sessionId, btnEl) {
            // UI state
            document.querySelectorAll('.session-item').forEach(b => b.classList.remove('active'));
            if (btnEl) btnEl.classList.add('active');

            document.getElementById('session-empty-state').classList.add('d-none');
            const view = document.getElementById('session-detail-view');
            view.classList.remove('d-none');
            view.style.opacity = '0.5';

            try {
                const res = await apiCall(`/api/sessions/${sessionId}`);
                const data = await res.json();
                view.style.opacity = '1';

                document.getElementById('detail-session-id').innerText = data.id;
                document.getElementById('detail-session-meta').innerText = `Session Archive â€¢ Files: ${data.audio.length} audio, ${data.clips.length} clips`;

                // Render Script Table
                const tbody = document.getElementById('detail-script-body');
                tbody.innerHTML = '';
                cleanupWavesurferGroup('archive'); // logic split or unified?

                if (data.script && data.script.segments) {
                    data.script.segments.forEach((seg, idx) => {
                        const tr = document.createElement('tr');
                        const audio = data.audio.find(a => a.stem === `segment_${idx}`);
                        const audioId = `archive-audio-${data.id}-${idx}`;

                        tr.innerHTML = `
                            <td><span class="badge text-bg-light border">${seg.id}</span></td>
                            <td class="small pe-4">${seg.text} <div class="mt-1 text-muted fw-bold" style="font-size: 0.65rem;">"${seg.on_screen_text}"</div></td>
                            <td class="small text-muted">${seg.visual_suggestion}</td>
                            <td><div id="${audioId}"></div></td>
                        `;
                        tbody.appendChild(tr);

                        if (audio) {
                            setTimeout(() => createMiniAudioPlayer(audio.url, audioId), 50);
                        } else {
                            document.getElementById(audioId).innerHTML = '<span class="small text-muted">No audio gen</span>';
                        }
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No script data available for this session.</td></tr>';
                }

                // Render Video Clips
                const clipsGrid = document.getElementById('detail-clips-grid');
                clipsGrid.innerHTML = '';
                if (data.clips.length > 0) {
                    data.clips.forEach(clip => {
                        const col = document.createElement('div');
                        col.className = 'col-md-6';
                        col.innerHTML = `
                            <div class="card border-0 shadow-sm bg-light">
                                <div class="card-body p-2">
                                    <video controls class="w-100 rounded mb-2" style="max-height: 200px; background: black;">
                                        <source src="${authUrl(clip.url)}" type="video/mp4">
                                    </video>
                                    <div class="small fw-bold text-center">${clip.name}</div>
                                </div>
                            </div>
                        `;
                        clipsGrid.appendChild(col);
                    });
                } else {
                    clipsGrid.innerHTML = '<div class="col-12 text-center py-4 text-muted">No video clips generated yet.</div>';
                }

                // Show Log
                document.getElementById('archive-log-preview').innerText = data.log || "No log entries found.";

                // Render Metadata
                const metaContent = document.getElementById('detail-meta-content');
                if (data.manifest && data.manifest.social_metadata) {
                    const sm = data.manifest.social_metadata;
                    metaContent.innerHTML = `
                        <div class="mb-3">
                            <h6 class="fw-bold text-uppercase small text-muted">LinkedIn Caption</h6>
                            <div class="p-2 bg-light rounded border">${sm.caption_linkedin}</div>
                        </div>
                        <div class="mb-3">
                            <h6 class="fw-bold text-uppercase small text-muted">TikTok Caption</h6>
                            <div class="p-2 bg-light rounded border">${sm.caption_tiktok}</div>
                        </div>
                        <div>
                            <h6 class="fw-bold text-uppercase small text-muted">Hashtags</h6>
                            <div>${sm.hashtags.map(h => `<span class="badge text-bg-info me-1">#${h}</span>`).join('')}</div>
                        </div>
                    `;
                } else {
                    metaContent.innerHTML = '<div class="text-center py-4 text-muted">Social metadata not generated yet for this session.</div>';
                }

                // Update Script Table with Image Thumbnails if available
                if (data.images && data.images.length > 0) {
                    data.script.segments.forEach((seg, idx) => {
                        const img = data.images.find(i => i.stem === `bg_${idx}`);
                        if (img) {
                            const visualCell = tbody.rows[idx].cells[2];
                            visualCell.innerHTML = `
                                <div class="mb-1">${seg.visual_suggestion}</div>
                                <img src="${authUrl(img.url)}" class="rounded shadow-sm border" style="width: 80px; cursor: zoom-in;" onclick="window.open(authUrl('${img.url}'))">
                           `;
                        }
                    });
                }

                // Actions
                const actions = document.getElementById('session-actions');
                actions.innerHTML = `
                    <a href="${authUrl(`/api/sessions/${sessionId}/download`)}" class="btn btn-sm btn-secondary fw-bold px-3">
                        <i class="bi bi-download me-1"></i> Download All (.zip)
                    </a>
                `;

            } catch (err) {
                console.error("Error loading session detail:", err);
            }
        }

        function cleanupWavesurferGroup(group) {
            // For now unified cleanup is enough as we switch tabs
            cleanupWavesurfers();
        }

        function showOutputPanel(data) {
            const view = document.getElementById('output-view');
            const manifest = data.manifest;

            view.innerHTML = `
                <div class="col-md-6 mb-4">
                    <h2 class="h6 fw-bold">Visual Production</h2>
                    <video controls class="w-100 rounded shadow">
                        <source src="${authUrl(`/api/files/${data.session_id}/finalize/${manifest.media_files.vertical_720p}`)}" type="video/mp4">
                    </video>
                    <div class="mt-3 d-grid gap-2">
                        <a href="${authUrl(`/api/files/${data.session_id}/finalize/${manifest.media_files.vertical_720p}`)}" download class="btn btn-primary btn-sm">Download 720p</a>
                        <a href="${authUrl(`/api/files/${data.session_id}/finalize/${manifest.media_files.square}`)}" download class="btn btn-secondary btn-sm">Download Square (IG)</a>
                    </div>
                </div>
                <div class="col-md-6">
                    <h2 class="h6 fw-bold">Social Pack</h2>
                    <div class="accordion" id="metaAccordion">
                        <div class="accordion-item">
                            <h3 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#metaLI">LinkedIn</button></h3>
                            <div id="metaLI" class="accordion-collapse collapse show"><div class="accordion-body small">${manifest.social_metadata.caption_linkedin}</div></div>
                        </div>
                        <div class="accordion-item">
                            <h3 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#metaTT">TikTok</button></h3>
                            <div id="metaTT" class="accordion-collapse collapse"><div class="accordion-body small">${manifest.social_metadata.caption_tiktok}</div></div>
                        </div>
                    </div>
                    <div class="mt-3">
                        ${manifest.social_metadata.hashtags.map(h => `<span class="badge text-bg-light border me-1">#${h}</span>`).join('')}
                    </div>
                </div>
            `;

            // Switch to output tab
            document.getElementById('output-tab').click();
            document.getElementById('pipeline-status-badge').className = 'badge text-bg-success me-3 my-auto fs-6 px-3 py-2';
            document.getElementById('pipeline-status-badge').innerText = 'COMPLETE';
            setIdleState();
        }

        // Event Listeners
        document.getElementById('btn-run').addEventListener('click', () => {
            if (isRunning) {
                apiCall('/api/cancel', { method: 'POST' });
                setIdleState();
                return;
            }

            const topic = document.getElementById('topic-override').value;
            apiCall('/api/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic })
            });
            toggleRunButton(true);
        });

        document.getElementById('btn-submit-override').addEventListener('click', () => {
            const content = document.getElementById('review-json').value;
            apiCall(`/api/override/${reviewStep}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(JSON.parse(content))
            });
            hideReviewPanel();
        });

        document.getElementById('btn-continue').addEventListener('click', () => {
            apiCall(`/api/override/${reviewStep}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            hideReviewPanel();
        });

        document.getElementById('btn-save-settings').addEventListener('click', () => {
            const settings = {
                timeout: document.getElementById('setting-timeout').value,
                threshold: document.getElementById('setting-threshold').value,
                ntfy: document.getElementById('setting-ntfy').value,
                model: document.getElementById('setting-model').value
            };
            apiCall('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            }).then(() => {
                settingsModalInstance.hide();
            });
        });

        document.getElementById('setting-threshold').addEventListener('input', (e) => {
            document.getElementById('qa-threshold-val').innerText = e.target.value;
        });

        document.getElementById('clear-log').addEventListener('click', () => {
            document.getElementById('log-view').innerHTML = '';
        });

        document.getElementById('archive-tab').addEventListener('shown.bs.tab', () => {
            loadSessions();
        });

        document.getElementById('refresh-sessions').addEventListener('click', () => {
            loadSessions();
        });

        // Periodic Status Update â€” full state reconciliation every 5s.
        // This is the safety net: even if socket events were missed, the stepper
        // will converge to the correct state within one poll cycle.
        setInterval(() => {
            if (!authReady) return; // Don't poll before auth is confirmed
            syncServerState(true).catch(() => { }); // silent=true: no log spam every 5s
        }, 5000);

    </script>
</body>

</html>