<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UX·AI UGC Content Agent</title>
    <!-- Bootswatch Lux Theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5/dist/lux/bootstrap.min.css">
    <style>
        body {
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            height: 100vh;
            padding: 2rem 1rem;
            position: fixed;
            width: 250px;
            z-index: 1000;
        }

        .main-content {
            margin-left: 250px;
            height: 100vh;
            overflow-y: auto;
            padding: 2rem;
            width: calc(100% - 250px);
        }

        .status-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            width: 100%;
            display: block;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .log-container {
            font-family: var(--bs-font-monospace);
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            padding: 1rem;
            background-color: var(--bs-tertiary-bg);
            border-radius: var(--bs-border-radius);
            border: var(--bs-border-width) solid var(--bs-border-color);
        }

        .log-line {
            margin-bottom: 0.2rem;
            font-size: 0.9rem;
        }

        .stepper-item {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            position: relative;
        }

        .stepper-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--bs-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-weight: bold;
            flex-shrink: 0;
            color: var(--bs-secondary);
        }

        .stepper-item.running .stepper-number {
            border-color: var(--bs-primary);
            color: var(--bs-primary);
            animation: pulse 1.5s infinite;
        }

        .stepper-item.done .stepper-number {
            background-color: var(--bs-success);
            border-color: var(--bs-success);
            color: var(--bs-white);
        }

        .stepper-item.error .stepper-number {
            background-color: var(--bs-danger);
            border-color: var(--bs-danger);
            color: var(--bs-white);
        }

        .stepper-item.active {
            border: 1px solid var(--bs-primary);
            border-radius: var(--bs-border-radius-lg);
            padding: 0.5rem;
            background: var(--bs-tertiary-bg);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb), 0.4);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(var(--bs-primary-rgb), 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb), 0);
            }
        }

        #review-panel {
            display: none;
        }

        .json-editor {
            font-family: var(--bs-font-monospace);
            font-size: 0.85rem;
            height: 300px;
            width: 100%;
            background-color: var(--bs-tertiary-bg);
            color: var(--bs-body-color);
            border: var(--bs-border-width) solid var(--bs-border-color);
            border-radius: var(--bs-border-radius);
            padding: 10px;
        }
    </style>
</head>

<body>

    <div class="sidebar bg-body-tertiary border-end shadow-sm">
        <h2 class="text-primary mt-2">UX·AI UGC</h2>
        <p class="text-muted text-uppercase small tracking-wide">Content Agent</p>
        <hr class="border-secondary opacity-25">

        <div id="pipeline-status-badge" class="badge status-badge bg-secondary mb-4">IDLE</div>

        <div class="mb-4">
            <label class="form-label d-flex justify-content-between small text-uppercase">
                <span class="text-muted">RAM Usage</span>
                <span id="ram-text" class="fw-bold">--%</span>
            </label>
            <div class="progress shadow-sm" style="height: 10px;">
                <div id="ram-progress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
            </div>
        </div>

        <div class="mb-4">
            <label class="form-label small text-muted text-uppercase">Topic Override</label>
            <input type="text" id="topic-override" class="form-control form-control-sm border-secondary"
                placeholder="e.g. Fintech UX gaps...">
        </div>

        <button id="btn-run" class="btn btn-success w-100 mb-4 fw-bold shadow-sm">▶ RUN PIPELINE</button>

        <hr class="border-secondary opacity-25 mb-4">

        <div class="d-flex justify-content-center">
            <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal">
                ⚙ Settings
            </button>
        </div>
    </div>

    <div class="main-content">
        <!-- Section 1: Progress -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div
                        class="card-header bg-transparent border-bottom-0 pt-4 pb-2 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-uppercase fw-bold text-primary">Pipeline Progress</h5>
                        <small id="session-display" class="text-muted"></small>
                    </div>
                    <div class="card-body">
                        <div id="stepper" class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3">
                            <!-- Steps dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Human Review Panel -->
        <div id="review-panel" class="row mb-4">
            <div class="col-12">
                <div class="card border-warning shadow-lg">
                    <div class="card-header text-bg-warning d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0 text-dark fw-bold">⏳ Review Window: <span id="review-step-name">--</span></h5>
                        <span id="countdown-text" class="text-dark small text-uppercase">Auto-continuing in --s</span>
                    </div>
                    <div class="progress rounded-0" style="height: 8px;">
                        <div id="countdown-bar" class="progress-bar bg-warning" role="progressbar" style="width: 100%">
                        </div>
                    </div>
                    <div class="card-body">
                        <textarea id="review-json" class="json-editor mb-3"></textarea>
                        <div class="d-flex justify-content-end gap-2">
                            <button id="btn-submit-override" class="btn btn-success">✅ Submit My Changes</button>
                            <button id="btn-continue" class="btn btn-secondary">⏭ Continue Now</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: Tabs -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-transparent border-bottom-0 pt-3 pb-0">
                        <ul class="nav nav-tabs border-bottom-0" id="mainTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active fw-bold text-uppercase" id="log-tab" data-bs-toggle="tab"
                                    data-bs-target="#log-pane" type="button" role="tab">Live Log</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link fw-bold text-uppercase" id="script-tab" data-bs-toggle="tab"
                                    data-bs-target="#script-pane" type="button" role="tab">Script Viewer</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link fw-bold text-uppercase" id="output-tab" data-bs-toggle="tab"
                                    data-bs-target="#output-pane" type="button" role="tab">Output</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body bg-body-tertiary rounded-bottom">
                        <div class="tab-content" id="mainTabContent">
                            <div class="tab-pane fade show active" id="log-pane" role="tabpanel">
                                <div class="d-flex justify-content-end mb-3">
                                    <button id="clear-log"
                                        class="btn btn-sm btn-outline-secondary text-uppercase flex-shrink-0">Clear
                                        Log</button>
                                </div>
                                <div id="log-view" class="log-container shadow-inner"></div>
                            </div>
                            <div class="tab-pane fade" id="script-pane" role="tabpanel">
                                <div id="qa-summary" class="mb-3"></div>
                                <div id="script-cards" class="row g-3">
                                    <h5 class="text-center text-muted py-5 mt-4">No script generated yet.</h5>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="output-pane" role="tabpanel">
                                <div id="output-view" class="row">
                                    <h5 class="text-center text-muted py-5 mt-4">Waiting for final render...</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header text-bg-primary">
                    <h5 class="modal-title fw-bold text-white">System Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Review Timeout (Seconds)</label>
                        <input type="number" id="setting-timeout" class="form-control" value="120">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">QA Approval Threshold (<span id="qa-threshold-val">7.5</span>)</label>
                        <input type="range" class="form-range" min="5" max="9" step="0.5" id="setting-threshold"
                            value="7.5">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ntfy URL</label>
                        <input type="text" id="setting-ntfy" class="form-control"
                            placeholder="https://ntfy.stargety.com/ugc">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Main LLM Model</label>
                        <input type="text" id="setting-model" class="form-control"
                            placeholder="anthropic/claude-sonnet-4-6">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button id="btn-save-settings" type="button" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        const steps = [
            "research", "review_research", "ideation", "scripting",
            "review_script", "qa_loop", "review_qa", "voiceover",
            "avatar_clips", "images", "assembly", "qa_video",
            "metadata", "finalize"
        ];

        const stepLabels = {
            "research": "Market Research",
            "review_research": "Review Findings",
            "ideation": "Content Ideas",
            "scripting": "Script Writing",
            "review_script": "Human Script Edit",
            "qa_loop": "QA Self-Correction",
            "review_qa": "Final Approval",
            "voiceover": "AI Voice Gen",
            "avatar_clips": "HeyGen Avatar",
            "images": "DALL-E Visuals",
            "assembly": "Video Rendering",
            "qa_video": "Technical Check",
            "metadata": "Social Metadata",
            "finalize": "Packaging"
        };

        let reviewTimer = null;
        let reviewStep = null;

        // Initialize Stepper
        const stepperEl = document.getElementById('stepper');
        steps.forEach((step, idx) => {
            const el = document.createElement('div');
            el.className = 'col';
            el.innerHTML = `
                <div id="step-${step}" class="stepper-item">
                    <div class="stepper-number">${idx + 1}</div>
                    <div>
                        <div class="fw-bold" style="font-size: 0.8rem;">${stepLabels[step]}</div>
                        <small class="step-status text-muted" style="font-size: 0.7rem;">Pending</small>
                    </div>
                </div>
            `;
            stepperEl.appendChild(el);
        });

        // Socket Listeners
        socket.on('step_start', (data) => updateStep(data.step, 'running'));
        socket.on('step_complete', (data) => updateStep(data.step, 'done', data));
        socket.on('step_error', (data) => updateStep(data.step, 'error', data));
        socket.on('pipeline_log', (data) => appendLog(data));
        socket.on('ram_update', (data) => updateRamBar(data));

        socket.on('review_window_open', (data) => showReviewPanel(data));
        socket.on('review_window_timeout', () => hideReviewPanel());
        socket.on('override_received', () => {
            hideReviewPanel();
            appendLog({ level: 'SUCCESS', msg: 'Human override applied successfully.' });
        });

        socket.on('pipeline_complete', (data) => showOutputPanel(data));

        // Core Functions
        function updateStep(step, status, data) {
            const el = document.getElementById(`step-${step}`);
            if (!el) return;

            el.classList.remove('running', 'done', 'error', 'active');
            el.classList.add(status);
            if (status === 'running') el.classList.add('active');

            const statusEl = el.querySelector('.step-status');
            statusEl.innerText = status.charAt(0).toUpperCase() + status.slice(1);

            if (status === 'done' && step === 'scripting') {
                renderScript(data.result);
            }
        }

        function appendLog(data) {
            const logView = document.getElementById('log-view');
            const line = document.createElement('div');
            const levelColors = { 'INFO': 'text-body', 'SUCCESS': 'text-success fw-bold', 'WARNING': 'text-warning fw-bold', 'ERROR': 'text-danger fw-bold', 'AGENT': 'text-info fw-bold' };
            line.className = `log-line mb-1 ${levelColors[data.level] || 'text-body'}`;
            const timestamp = new Date().toLocaleTimeString();
            line.innerText = `[${timestamp}] [${data.level}] ${data.msg}`;
            logView.appendChild(line);
            logView.scrollTop = logView.scrollHeight;
        }

        function updateRamBar(data) {
            const bar = document.getElementById('ram-progress');
            const text = document.getElementById('ram-text');
            bar.style.width = data.percent + '%';
            text.innerText = data.percent + '%';

            if (data.percent > 90) bar.className = 'progress-bar bg-danger';
            else if (data.percent > 70) bar.className = 'progress-bar bg-warning';
            else bar.className = 'progress-bar bg-info';
        }

        function showReviewPanel(data) {
            reviewStep = data.step;
            document.getElementById('review-step-name').innerText = stepLabels[data.step] || data.step;
            document.getElementById('review-json').value = JSON.stringify(data.data, null, 2);
            document.getElementById('review-panel').style.display = 'block';

            let remaining = data.timeout;
            const total = data.timeout;

            clearInterval(reviewTimer);
            reviewTimer = setInterval(() => {
                remaining -= 1;
                const pct = (remaining / total) * 100;
                const bar = document.getElementById('countdown-bar');
                bar.style.width = pct + '%';
                document.getElementById('countdown-text').innerText = `Auto-continuing in ${remaining}s`;

                if (remaining <= 20) bar.className = 'progress-bar bg-danger';
                else bar.className = 'progress-bar bg-warning';

                if (remaining <= 0) {
                    clearInterval(reviewTimer);
                    hideReviewPanel();
                }
            }, 1000);

            document.getElementById('review-panel').scrollIntoView({ behavior: 'smooth' });
        }

        function hideReviewPanel() {
            document.getElementById('review-panel').style.display = 'none';
            clearInterval(reviewTimer);
        }

        function renderScript(script) {
            const container = document.getElementById('script-cards');
            container.innerHTML = '';

            if (!script || !script.segments) return;

            script.segments.forEach(seg => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';
                col.innerHTML = `
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge bg-secondary">${seg.id}</span>
                                <span class="badge bg-primary">${seg.duration_seconds}s</span>
                            </div>
                            <p class="small mb-2">${seg.text}</p>
                            <hr>
                            <div class="small text-muted"><strong>Screen:</strong> ${seg.on_screen_text}</div>
                            <div class="small text-muted italic"><strong>Mood:</strong> ${seg.emotion_cue}</div>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        function showOutputPanel(data) {
            const view = document.getElementById('output-view');
            const manifest = data.manifest;

            view.innerHTML = `
                <div class="col-md-6 mb-4">
                    <h6>Visual Production</h6>
                    <video controls class="w-100 rounded shadow">
                        <source src="/api/files/${manifest.media_files.vertical_720p}" type="video/mp4">
                    </video>
                    <div class="mt-3 d-grid gap-2">
                        <a href="/api/files/${manifest.media_files.vertical_720p}" download class="btn btn-outline-primary btn-sm">Download 720p</a>
                        <a href="/api/files/${manifest.media_files.square}" download class="btn btn-outline-secondary btn-sm">Download Square (IG)</a>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>Social Pack</h6>
                    <div class="accordion" id="metaAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#metaLI">LinkedIn</button></h2>
                            <div id="metaLI" class="accordion-collapse collapse show"><div class="accordion-body small">${manifest.social_metadata.caption_linkedin}</div></div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#metaTT">TikTok</button></h2>
                            <div id="metaTT" class="accordion-collapse collapse"><div class="accordion-body small">${manifest.social_metadata.caption_tiktok}</div></div>
                        </div>
                    </div>
                    <div class="mt-3">
                        ${manifest.social_metadata.hashtags.map(h => `<span class="badge bg-light text-dark border me-1">#${h}</span>`).join('')}
                    </div>
                </div>
            `;

            // Switch to output tab
            document.getElementById('output-tab').click();
            document.getElementById('pipeline-status-badge').className = 'badge status-badge bg-success';
            document.getElementById('pipeline-status-badge').innerText = 'COMPLETE';
        }

        // Event Listeners
        document.getElementById('btn-run').addEventListener('click', () => {
            const topic = document.getElementById('topic-override').value;
            fetch('/api/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic })
            });
            document.getElementById('pipeline-status-badge').className = 'badge status-badge bg-primary';
            document.getElementById('pipeline-status-badge').innerText = 'RUNNING';
        });

        document.getElementById('btn-submit-override').addEventListener('click', () => {
            const content = document.getElementById('review-json').value;
            fetch(`/api/override/${reviewStep}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(JSON.parse(content))
            });
            hideReviewPanel();
        });

        document.getElementById('btn-continue').addEventListener('click', () => {
            fetch(`/api/override/${reviewStep}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            hideReviewPanel();
        });

        document.getElementById('btn-save-settings').addEventListener('click', () => {
            const settings = {
                timeout: document.getElementById('setting-timeout').value,
                threshold: document.getElementById('setting-threshold').value,
                ntfy: document.getElementById('setting-ntfy').value,
                model: document.getElementById('setting-model').value
            };
            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            }).then(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
                modal.hide();
            });
        });

        document.getElementById('setting-threshold').addEventListener('input', (e) => {
            document.getElementById('qa-threshold-val').innerText = e.target.value;
        });

        document.getElementById('clear-log').addEventListener('click', () => {
            document.getElementById('log-view').innerHTML = '';
        });

        // Periodic Status Update
        setInterval(() => {
            fetch('/api/status').then(r => r.json()).then(data => {
                updateRamBar({ percent: data.ram_percent });
                if (data.status === 'running') {
                    document.getElementById('pipeline-status-badge').innerText = 'RUNNING';
                }
            });
        }, 5000);
    </script>
</body>

</html>